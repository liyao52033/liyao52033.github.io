(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{585:function(a,s,t){"use strict";t.r(s);var n=t(3),e=Object(n.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p",[a._v("首先，还是通过 vue cli 创建项目（要用 5.0 以上的 cli）：")]),a._v(" "),s("p",[a._v("安装 @vue/cli 后执行 vue create vue-demo 创建 vue 项目：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141454651.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("选择 vue3 的模版。")]),a._v(" "),s("p",[a._v("安装完之后进入到 vue-demo 目录，执行 npm run serve 把开发服务跑起来。")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141455802.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("浏览器访问，会看到渲染出的页面：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141455372.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("修改下 vue.config.js，把 devtool 改成 source-map：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141455045.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("然后我们进行调试：")]),a._v(" "),s("p",[a._v("点击调试窗口的 create a launch.json file 来创建调试配置文件：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141455123.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("修改调试配置如下：")]),a._v(" "),s("div",{staticClass:"language-json line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"type"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"chrome"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" \n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"request"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"launch"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" \n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"name"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"调试 Vue 项目"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" \n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"runtimeExecutable"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"canary"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" \n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"runtimeArgs"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"--auto-open-devtools-for-tabs"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" \n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"userDataDir"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" \n    "),s("span",{pre:!0,attrs:{class:"token property"}},[a._v('"url"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"http://localhost:8081"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br")])]),s("p",[a._v("这样就可以在 VSCode 里打断点调试了。")]),a._v(" "),s("p",[a._v("但是这样调试 Vue 源码的话还不够，你会发现调用栈里的路径是 node_modules 下的 runtime-core.esm-bundler.js：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141456316.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("这明显是经过编译打包之后的，而我们想要调试的是 Vue 最初的源码。")]),a._v(" "),s("p",[a._v("这就需要用到 sourcemap 了。")]),a._v(" "),s("p",[a._v("从 npm 下载的 vue 包是不带 sourcemap 的，我们需要把源码下载下来自己 build。")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" clone https://github.com/vuejs/core vue3\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("下载 vue3 的代码，用 pnpm install 安装依赖（这是 vue3 指定的依赖管理工具）。")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("pnpm")]),a._v(" run build，\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("就会在每个包下产生 dist 目录：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141457699.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("这时候的产物肯定是不带 sourcemap 的。")]),a._v(" "),s("p",[a._v("那难道也要像调试 React 源码那样改造 build 脚本么？")]),a._v(" "),s("p",[a._v("这个倒不用，vue3 源码里贴心的为需要生成 sourcemap 的情况做了支持。")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141458783.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("只要配置下这个环境变量就行。")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("set")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("SOURCE_MAP")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("true "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("pnpm")]),a._v(" run build：\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141459377.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("build 完成后，再去看包下的 dist 产物，你就会发现有 sourcemap 了：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141459287.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("相比 react 源码生成 sourcemap 简单了很多。")]),a._v(" "),s("p",[a._v("把 runtime-core 包下的 dist 复制出来，覆盖 vue-demo 项目的 node_modules 下的 dist 目录：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141500157.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("重新跑 npm run serve，并且重新 debug：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141500572.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("这时候你会发现调试的就是源码了，很明显是 src 下的 ts 文件。")]),a._v(" "),s("p",[a._v("对比下之前的：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141500294.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("是不是瞬间就懂了为什么要用 sourcemap 了？")]),a._v(" "),s("p",[a._v("当然，这里把 sourcemap 应用到项目里也没有 create-react-app 里那么费劲，明显是 vue-cli 对 node_modules 下的 sourcemap 做了支持，简单了很多。")]),a._v(" "),s("p",[a._v("只不过现在 sourcemap 到的路径不大对，没有 runtime-core 的包名，不能编辑：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141500895.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("这种情况有两种处理方式，")]),a._v(" "),s("p",[a._v("一种是配置下 sourceMapPathOverrides，把这段路径再做一次映射，映射到源码目录就可以了。")]),a._v(" "),s("p",[a._v("另一种方式就是改造下 vue3 的 build 脚本，让生成的 sourcemap 就直接是正确的路径。")]),a._v(" "),s("p",[a._v("我们采用第二种方式。")]),a._v(" "),s("p",[a._v("再次打开 vue3 源码目录，找到 rollup.config.js 里 sourcemap 配置的地方，添加一段配置:")]),a._v(" "),s("div",{staticClass:"language-javascript line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[a._v("output"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[a._v("sourcemapPathTransform")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[a._v("relativeSourcePath"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" sourcemapPath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=>")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("const")]),a._v(" newSourcePath "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("join")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("dirname")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("sourcemapPath"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" relativeSourcePath"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" newSourcePath"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("p",[a._v("这里的两个参数，sourcemapPath 就是 sourcemap 的绝对路径，，而 relativeSourcePath 是 sourcemap 的路径到源码路径的相对路径")]),a._v(" "),s("p",[a._v("那要计算出源码的绝对路径，就可以先取 sourcemapPath 的目录路径，然后再根据相对路径查找到源码文件，这样就是源码的绝对路径了。")]),a._v(" "),s("p",[a._v("加了这个配置之后，重新 build 一下：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141502370.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("这时候生成的 sourcemap 里的源码路径就是绝对路径。")]),a._v(" "),s("p",[a._v("用新的 dist 目录覆盖 vue-demo 的 node_modules 下的 @vue/runtime-core 的 dist 目录，然后重新 npm run serve：")]),a._v(" "),s("p",[a._v("这时候调用栈中的 vue 代码就是源码的绝对路径了，能找到文件，自然也就不再是只读：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141502147.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("如果你重新跑 npm run serve，那可能是有 babel loader 的缓存：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141503936.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("手动 删除一下缓存")]),a._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-rf")]),a._v(" ./node_modules/.cache/babel-loader\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("当然，更好的体验还是像调试 React 代码那样，把 vue 源码和 vue-demo 项目放到同一个 workspace 下：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141503254.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("这里因为移动了 vue3 源码的位置，那 sourcemap 到的路径变了，所以还要进入 vue3 源码路径重新 build 依次，再把 sourcemap 复制到 vue-demo 目录的 node_modules 下。")]),a._v(" "),s("p",[a._v("再次调试，点击调用栈中的源码，就能直接在 workspace 里打开：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141503959.gif",loading:"lazy"}})]),a._v(" "),s("p",[a._v("之后就能愉快的调试 vue 源码了。")]),a._v(" "),s("p",[a._v("对比下之前的调用栈：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141503002.png",loading:"lazy"}})]),a._v(" "),s("p",[a._v("再看下现在的调用栈：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/202401141504966.jpeg",loading:"lazy"}})]),a._v(" "),s("p",[a._v("点击就可以打开源码目录下的对应文件。")]),a._v(" "),s("p",[a._v("你平时开发的项目也可以这样把 node_modules 下 的 @vue/runtime-core 的 dist 目录替换掉，这样调试项目之余，还可以看看源码。把 vue 也加到 workspace 那一步倒不是必须的。")]),a._v(" "),s("p",[a._v("有的同学用 vite 调试 vue3 源码，也可以，但要把 vue 的预加载禁用，不然路径就变了：")]),a._v(" "),s("p",[s("img",{staticClass:"lazy",attrs:{alt:"img","data-src":"https://img.xiaoying.org.cn/img/20250707171437721.png",loading:"lazy"}})]),a._v(" "),s("div",{staticClass:"language-vue line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-vue"}},[s("code",[a._v('optimizeDeps: {\n   exclude: ["vue"]\n}\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[a._v("#")]),a._v(" 总结")]),a._v(" "),s("p",[a._v("这节我们调试了下 vue 源码，它同样也需要 sourcemap，我们下载了 vue 源码，然后 build 出了带有 sourcemap 的代码，覆盖 demo 项目的 node_modules 下的包，之后再次调试就可以直接调试源码了。")]),a._v(" "),s("p",[a._v("但是这时候 sourcemap 到的路径不对，所以源码文件是只读的。我们修改了 build 配置，通过 output.sourcemapPathTransform 修改了 sourcemap 到的源码地址，再次调试就能找到源码的绝对路径，这样内容就是可修改的了。")]),a._v(" "),s("p",[a._v("如果想点击调用栈直接在 workspace 打开对应的文件，这需要把 demo 项目和 vue3 源码项目放到一个 workspace 下，再次调试就可以了。")]),a._v(" "),s("p",[a._v("vue3 源码的调试整体比 react 源码调试简单不少，因为不管是生成 sourcemap 还是把 sourcemap 加到项目里，vue 都做了不错的支持。")])])}),[],!1,null,null,null);s.default=e.exports}}]);