(window.webpackJsonp=window.webpackJsonp||[]).push([[133],{657:function(s,a,e){"use strict";e.r(a);var t=e(3),n=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("ACME（自动证书管理环境）是一个互联网工程任务组维护的协议，它允许自动化 Web 服务器证书的部署，"),a("a",{attrs:{href:"https://github.com/acmesh-official/acme.sh",target:"_blank",rel:"noopener noreferrer"}},[s._v("acme.sh"),a("OutboundLink")],1),s._v(" 是支持 ACME 协议流行的客户端之一，可以通过其实现 SSL 证书的自动申请、续期等。本文将为您介绍如何使用 acme.sh 自动申请证书。")]),s._v(" "),a("h2",{attrs:{id:"安装-acme-sh"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-acme-sh"}},[s._v("#")]),s._v(" 安装 acme.sh")]),s._v(" "),a("h3",{attrs:{id:"全新安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#全新安装"}},[s._v("#")]),s._v(" 全新安装")]),s._v(" "),a("p",[s._v("适用于未安装 acme.sh 的用户，使用以下命令安装 acme.sh 客户端：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" https://get.acme.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("email")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("my@example.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("或者：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-O")]),s._v(" -  https://get.acme.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("email")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("my@example.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("说明")]),s._v(" "),a("p",[s._v("请将 my@example.com 替换为您的邮箱地址")])]),s._v(" "),a("p",[s._v("然后稍等片刻，如下图，出现Install success 的提示表示安装成功了。通过安装日志，可以看到安装目录，并且还看到创建一个 cron job，这个job就是自动更新证书的定时任务。")]),s._v(" "),a("p",[a("img",{staticClass:"lazy",attrs:{alt:"图片","data-src":"https://img.xiaoying.org.cn/img/202408291217518.webp",loading:"lazy"}})]),s._v(" "),a("p",[s._v("还有一种克隆仓库的安装方式。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/acmesh-official/acme.sh.git\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" ./acme.sh\n./acme.sh "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--install")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("安装位置在这里，也就是当前用户home目录中。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Installing to /root/.acme.sh\nInstalled to /root/.acme.sh/acme.sh\nInstalling "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("alias")]),s._v(" to "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/root/.bashrc'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"旧版升级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#旧版升级"}},[s._v("#")]),s._v(" 旧版升级")]),s._v(" "),a("p",[s._v("适用于已安装 acme.sh 的用户，请运行以下命令升级 acme.sh 客户端：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("acme.sh "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--upgrade")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"将-acme-sh注册为全局命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#将-acme-sh注册为全局命令"}},[s._v("#")]),s._v(" 将 acme.sh注册为全局命令")]),s._v(" "),a("p",[s._v("要使 "),a("code",[s._v("acme.sh")]),s._v(" 命令在全局范围内可用，可以创建一个符号链接，将 "),a("code",[s._v("acme.sh")]),s._v(" 脚本链接到 "),a("code",[s._v("/usr/local/bin/")]),s._v(" 目录中。这样，你可以在任何地方使用 "),a("code",[s._v("acme.sh")]),s._v(" 命令。")]),s._v(" "),a("p",[s._v("执行以下命令创建符号链接：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" ~/acme.sh /usr/local/bin/acme.sh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("验证 "),a("code",[s._v("acme.sh")]),s._v(" 是否已成功注册为全局命令")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("acme.sh "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--version")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("如果 "),a("code",[s._v("acme.sh")]),s._v(" 已正确安装并注册为全局命令，上述命令会显示 "),a("code",[s._v("acme.sh")]),s._v(" 的版本信息。")]),s._v(" "),a("h2",{attrs:{id:"账号注册"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#账号注册"}},[s._v("#")]),s._v(" 账号注册")]),s._v(" "),a("p",[s._v("初次使用，可能需要注册账号，一个邮箱即可（此步可先跳过，等到执行具体命令时如果提示，再注册不迟）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("acme.sh --register-account -m example.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("acme 默认使用的是 ZeroSSL，但是 ZeroSSL 不是很稳定，如果可能的话，可以切换到letsencrypt，当然了，不切换也无所谓。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("acme.sh  --set-default-ca --server letsencrypt\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("登录变量将被保存~/.acme.sh/account.conf并在需要时重新使用。")]),s._v(" "),a("h2",{attrs:{id:"生成证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#生成证书"}},[s._v("#")]),s._v(" 生成证书")]),s._v(" "),a("p",[s._v("有两种方式生成证书，一种是 HTTP 方式，另一种是 DNS 方式。")]),s._v(" "),a("p",[s._v("比较推荐使用 DNS 方式，域名不用备案，而且可以自动更新续期。")]),s._v(" "),a("h3",{attrs:{id:"http-方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http-方式"}},[s._v("#")]),s._v(" "),a("strong",[s._v("HTTP 方式")])]),s._v(" "),a("p",[s._v("下面这个命令是 HTTP 方式，-d 后面是域名，--webroot 后面是网站根目录。这种方式会在你的服务器根目录生成一个验证文件，然后通过80端口访问")]),s._v(" "),a("p",[s._v("但是先别着急执行啊，这种方式在国内有个问题，就是你的域名必须要先备案，要不然 80 端口会被工信部的未备案提示页面拦截，导致没办法生成证书。")]),s._v(" "),a("p",[s._v("所以域名在国内或者服务器在国内，最好还是别用这种方式。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("acme.sh "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--issue")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" example.com "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--webroot")]),s._v(" /web/\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"dns-方式和自动更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dns-方式和自动更新"}},[s._v("#")]),s._v(" "),a("strong",[s._v("DNS 方式和自动更新")])]),s._v(" "),a("p",[s._v("在"),a("a",{attrs:{href:"https://github.com/acmesh-official/acme.sh/wiki/dnsapi2",target:"_blank",rel:"noopener noreferrer"}},[s._v("acme.sh的github"),a("OutboundLink")],1),s._v(" ，可以看到所支持的域名供应商，只要能在这里面找到的，都支持 DNS 方式验证，基本上市面上你能买到域名的地方都可以用这种方式，阿里云、华为云、腾讯云等等都在其中，里面有具体的参数说明。")]),s._v(" "),a("p",[s._v("以腾讯云为例，首先根据"),a("a",{attrs:{href:"https://cloud.tencent.com/document/product/302/105900",target:"_blank",rel:"noopener noreferrer"}},[s._v("腾讯云官方文档"),a("OutboundLink")],1),s._v("获取腾讯云 SecretId 和 SecretKey，然后将这两个值导入环境变量。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Tencent_SecretId")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"<Your SecretId>"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Tencent_SecretKey")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"<Your SecretKey>"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("之后再执行生成证书的命令")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("acme.sh "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--issue")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--dns")]),s._v(" dns_tencent "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" xiaoying.org.cn "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" *.xiaoying.org.cn\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("或者")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("acme.sh "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--issue")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" xiaoying.org.cn  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'*.xiaoying.org.cn'")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--dns")]),s._v(" dns_cf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("执行这个命令后，"),a("code",[s._v("acme.sh")]),s._v(" 将尝试生成一个包含所有这些域名的SSL/TLS证书。这意味着你将得到一个证书，而不是两个单独的证书。这个证书将允许你使用单个证书来保护 "),a("code",[s._v("xiaoying.org.cn")]),s._v(" 及其所有子域名，并保存在"),a("code",[s._v("~/.acme.sh/example.com/")]),s._v("目录下，并且会自动为您的域名配置证书自动续期任务，无需手动续期。")]),s._v(" "),a("h2",{attrs:{id:"安装和配置-ssl-证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装和配置-ssl-证书"}},[s._v("#")]),s._v(" 安装和配置 SSL 证书")]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("acme.sh 不建议直接使用"),a("code",[s._v("~/.acme.sh/")]),s._v("目录下的证书文件，而是通过 acme.sh 提供的命令将证书安装到指定位置，以确保证书的正确使用和续期，详情请参见 "),a("a",{attrs:{href:"https://github.com/acmesh-official/acme.sh?tab=readme-ov-file#3-install-the-cert-to-apachenginx-etc",target:"_blank",rel:"noopener noreferrer"}},[s._v("Install the cert to Apache/Nginx etc"),a("OutboundLink")],1),s._v("，以下以 Nginx 为例。")]),s._v(" "),a("p",[s._v("申请多个证书时每个创建单独的文件夹存放，以免不同域名的"),a("code",[s._v("fullchain.cer")]),s._v("相互覆盖，只保留最后生成的那个造成证书不匹配的报错")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@VM-4-16-centos nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nginx -t")]),s._v("\nnginx: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("emerg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" SSL_CTX_use_PrivateKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/nginx/xiaoying.org.cn.key"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" failed "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("SSL: error:0B080074:x509 certificate routines:X509_check_private_key:key values mismatch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("acme.sh --install-cert  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" xiaoying.org.cn  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--key-file       /etc/nginx/xiaoying.org.cn.key  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--fullchain-file  /etc/nginx/fullchain.cer "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--reloadcmd")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"service nginx force-reload"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("完成申请后请将证书配置到您的网站中，以 Nginx 为例，示例如下：")]),s._v(" "),a("div",{staticClass:"language-nginx line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(" ssl http2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" example.com")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请替换为证书实际路径")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_certificate")]),s._v(" /etc/nginx/fullchain.cer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_certificate_key")]),s._v(" /etc/nginx/xiaoying.org.cn.key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_session_timeout")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5m")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_protocols")]),s._v(" TLSv1.2 TLSv1.3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_ciphers")]),s._v(" ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_prefer_server_ciphers")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("off")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ssl_prefer_server_ciphers")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v(" /nginx/www/html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("完成后使用"),a("code",[s._v("systemctl restart nginx")]),s._v("请重载服务。")])]),s._v(" "),a("h2",{attrs:{id:"自动更新acme"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自动更新acme"}},[s._v("#")]),s._v(" 自动更新acme")]),s._v(" "),a("p",[s._v("现在证书已经可以自动更新了，但是 acme 还没有。因为各个免费 SSL 证书平台的规则不是一成不变的，随着他们的更新，acme也会相应的修改规则。")]),s._v(" "),a("p",[s._v("所以，你可以在服务器上执行下面的命令，设置acme 自动升级，保证可用性。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("acme.sh "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--upgrade")]),s._v(" --auto-upgrade\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"自动安装到nginx路径"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自动安装到nginx路径"}},[s._v("#")]),s._v(" 自动安装到nginx路径")]),s._v(" "),a("p",[s._v("在/root下新增renew_cert.sh，内容如下")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加载 acme.sh 的环境变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" /root/.acme.sh/account.conf\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 请求新的证书")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/root/.acme.sh"')]),s._v("/acme.sh "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--issue")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--dns")]),s._v(" dns_tencent "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" xiaoying.org.cn "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" *.xiaoying.org.cn\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装并更新证书")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/root/.acme.sh"')]),s._v("/acme.sh --install-cert "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" xiaoying.org.cn "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--key-file /etc/nginx/xiaoying.org.cn.key "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--fullchain-file /etc/nginx/fullchain.cer "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--reloadcmd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"service nginx force-reload"')]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启nginx")]),s._v("\nsystemctl restart nginx\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("然后新建定时任务"),a("code",[s._v("crontab -e")]),s._v("，内容如下")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装acme自动添加的")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" * * * "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/root/.acme.sh"')]),s._v("/acme.sh "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cron")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--home")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/root/.acme.sh"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /dev/null\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 自动执行安装到nginx路径")]),s._v("\n00 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(" * * * /root/renew_cert.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /dev/null\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h2",{attrs:{id:"常见问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常见问题"}},[s._v("#")]),s._v(" 常见问题")]),s._v(" "),a("h3",{attrs:{id:"_1、端口被占用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、端口被占用"}},[s._v("#")]),s._v(" 1、端口被占用")]),s._v(" "),a("p",[s._v("检查是否有重复的 NGINX 实例")]),s._v(" "),a("p",[s._v("有时候，重复启动多个 NGINX 实例可能导致端口冲突。你可以使用以下命令检查 NGINX 是否已经在运行")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" aux "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" nginx\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("如果有多个 NGINX 实例在运行，可以通过下列指令来结束所有 NGINX 进程")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("pkill")]),s._v(" nginx \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_2、查看申请证书列表"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、查看申请证书列表"}},[s._v("#")]),s._v(" 2、查看申请证书列表")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("acme.sh "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--list")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_3、修改-nginx-服务的重启命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3、修改-nginx-服务的重启命令"}},[s._v("#")]),s._v(" 3、修改 Nginx 服务的重启命令")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /usr/lib/systemd/system/nginx.service\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("在文件中找到 "),a("code",[s._v("ExecReload")]),s._v(" 行。它应该看起来像这样：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ExecReload=/usr/sbin/nginx -s reload\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("将 "),a("code",[s._v("ExecReload")]),s._v(" 行修改为使用 "),a("code",[s._v("systemctl")]),s._v(" 来重启服务：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ExecReload=/bin/systemctl restart nginx\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v(":wq")]),s._v("保存并关闭文件。")]),s._v(" "),a("p",[s._v("为了使更改生效，重新加载 systemd 管理器配置：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("systemctl daemon-reload\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_4、删除证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4、删除证书"}},[s._v("#")]),s._v(" 4、删除证书")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("acme.sh  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--remove")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" example.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);